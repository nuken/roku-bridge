<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roku Bridge Status & Config</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
	<link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <style>
        /* (Existing styles remain unchanged) */
    </style>
</head>
<body>
    <div class="container">
        <div class="section-header" style="padding-bottom: 10px; margin-top: 20px;">
            <h2><i class="fa-solid fa-film"></i> On-Demand Apps</h2>
            <span class="m3u-url">M3U: <a id="ondemand-m3u-url" href="/ondemand.m3u" target="_blank">/ondemand.m3u</a><button class="action-button copy-button" title="Copy full URL" onclick="copyToClipboard('ondemand-m3u-url')"><i class="fa-solid fa-copy"></i></button></span>
        </div>
        <div class="table-wrapper">
            <table id="ondemand-apps-table">
                <thead><tr><th>Name</th><th>ID</th><th>App ID</th><th>Actions</th></tr></thead>
                <tbody id="ondemand-apps-table-body"></tbody>
            </table>
        </div>
        <button class="button" onclick="openOnDemandModal()"><i class="fa-solid fa-plus"></i> Add On-Demand App</button>
        <button id="save-all-button" class="button" onclick="saveAllChanges()"><i class="fa-solid fa-save"></i> Save All Changes</button>

        <div class="nav-links">
             <a href="/remote">Go to Remote</a>
             <a href="/preview">Live TV Preview</a>
             <a href="/pretune">On-Demand Pre-Tune</a>
        </div>
    </div>

    <div id="ondemand-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="ondemand-modal-title">Edit On-Demand App</h3>
                <span class="close-button" onclick="closeModal('ondemand-modal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="ondemand-form">
                    <input type="hidden" id="ondemand-index">
                    <div class="form-group">
                        <label for="ondemand-name">Name</label>
                        <input type="text" id="ondemand-name" required>
                    </div>
                    <div class="form-group">
                        <label for="ondemand-id">ID</label>
                        <input type="text" id="ondemand-id" required>
                    </div>
                    <div class="form-group">
                        <label for="ondemand-roku-app-id">Roku App ID</label>
                        <input type="text" id="ondemand-roku-app-id" required>
                    </div>
                    <button type="submit" class="button">Save App</button>
                </form>
            </div>
        </div>
    </div>
    <script>
        let appConfig = { tuners: [], channels: [], epg_channels: [], ondemand_apps: [] }; // Add ondemand_apps

        // (All existing JavaScript functions remain)

        function renderAllTables() {
            renderTuners();
            renderChannels('gracenote');
            renderChannels('epg');
            renderOnDemandApps(); // Add this call
        }

        // ====== NEW ON-DEMAND RENDER/MODAL FUNCTIONS ======
        function renderOnDemandApps() {
            const tbody = document.getElementById('ondemand-apps-table-body');
            tbody.innerHTML = (appConfig.ondemand_apps || []).map((app, i) => `
                <tr>
                    <td>${app.name}</td>
                    <td>${app.id}</td>
                    <td>${app.roku_app_id}</td>
                    <td>
                        <button class="action-button edit" onclick="openOnDemandModal(${i})"><i class="fa-solid fa-pencil"></i></button>
                        <button class="action-button delete" onclick="deleteItem('ondemand_apps', ${i})"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function openOnDemandModal(index = null) {
            const form = document.getElementById('ondemand-form');
            form.reset();
            document.getElementById('ondemand-modal-title').textContent = index === null ? 'Add On-Demand App' : 'Edit App';
            document.getElementById('ondemand-index').value = index !== null ? index : '';
            if (index !== null) {
                const app = appConfig.ondemand_apps[index];
                form.querySelector('#ondemand-name').value = app.name || '';
                form.querySelector('#ondemand-id').value = app.id || '';
                form.querySelector('#ondemand-roku-app-id').value = app.roku_app_id || '';
            }
            openModal('ondemand-modal');
        }

        document.getElementById('ondemand-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const index = this.querySelector('#ondemand-index').value;
            const data = {
                name: this.querySelector('#ondemand-name').value,
                id: this.querySelector('#ondemand-id').value,
                roku_app_id: this.querySelector('#ondemand-roku-app-id').value
            };
            if (index) {
                appConfig.ondemand_apps[parseInt(index, 10)] = data;
            } else {
                if (!appConfig.ondemand_apps) appConfig.ondemand_apps = [];
                appConfig.ondemand_apps.push(data);
            }
            renderOnDemandApps();
            closeModal('ondemand-modal');
        });
        // ================================================

        document.addEventListener('DOMContentLoaded', () => {
            // ... (existing DOMContentLoaded logic)
            const host = window.location.origin;
            document.getElementById('gracenote-m3u-url').href = `${host}/channels.m3u`;
            document.getElementById('epg-m3u-url').href = `${host}/epg_channels.m3u`;
            document.getElementById('ondemand-m3u-url').href = `${host}/ondemand.m3u`; // Add this line
        });
    </script>
</body>
</html>
