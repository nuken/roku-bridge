<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roku Bridge Status & Config</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --bg-color: #2c2c2c;
            --surface-color: #3a3a3a;
            --primary-color: #7dd3fc;
            --text-color: #e0e0e0;
            --border-color: #4a4a4a;
            --success-color: #28a745;
            --error-color: #dc3545;
            --button-color: #007bff;
            --button-hover-color: #0056b3;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: var(--surface-color);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            transition: max-width 0.3s ease-in-out;
        }
        .container.full-width {
            max-width: 95%;
        }
        h1, h2 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        h1 {
            justify-content: space-between;
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            border-bottom: 2px solid var(--border-color);
        }
        .section-header h2 {
            border-bottom: none;
            padding-bottom: 0;
            margin: 0;
        }
        .m3u-url {
            background-color: var(--border-color);
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .m3u-url a {
            color: var(--primary-color);
            text-decoration: none;
        }
        .m3u-url a:hover {
            text-decoration: underline;
        }
        .copy-button {
            padding: 4px 8px;
            font-size: 0.8em;
        }
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: 8px;
            margin-top: 20px;
            max-height: 400px; /* Added max-height */
            overflow-y: auto; /* Added overflow-y */
        }
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        th {
            background-color: var(--border-color);
            position: sticky; /* Make headers stick during scroll */
            top: 0;
            z-index: 1;
        }
        .status-icon .fa-check-circle { color: var(--success-color); }
        .status-icon .fa-times-circle { color: var(--error-color); }
        .status-icon .fa-spinner { color: var(--primary-color); animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .button, .action-button {
            background-color: var(--button-color);
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .button:hover, .action-button:hover { background-color: var(--button-hover-color); }
        .action-button { font-size: 0.9em; padding: 6px 10px; }
        .action-button.edit { background-color: #ffc107; }
        .action-button.delete { background-color: var(--error-color); }
        .action-button.edit:hover { background-color: #d39e00; }
        .action-button.delete:hover { background-color: #b22222; }
        .nav-links { text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border-color); }
        .nav-links a { color: var(--primary-color); text-decoration: none; margin: 0 15px; font-size: 1.1em; }
        .global-settings, .backup-restore {
            background-color: #222;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .global-settings p { margin: 5px 0; }
        .global-settings code { background-color: var(--border-color); padding: 2px 5px; border-radius: 4px; }
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.6);
        }
        .modal-content {
            background-color: var(--surface-color); margin: 5% auto; padding: 20px; border-radius: 12px;
            width: 90%; max-width: 600px; box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        .modal-body {
             overflow-y: auto;
             padding-right: 15px; /* Added padding */
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 20px; }
        .modal-header h3 { margin: 0; color: var(--primary-color); }
        .close-button { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #555;
            background-color: var(--border-color); color: var(--text-color); font-size: 1em; box-sizing: border-box;
        }
        .form-group-checkbox { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        .form-group-checkbox input { width: auto; }
        #save-all-button {
            background-color: var(--success-color);
            width: 100%;
            padding: 15px;
            font-size: 1.2em;
            margin-top: 20px;
        }
        #save-all-button:hover { background-color: #218838; }
        .notification {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            padding: 10px 20px; border-radius: 8px; z-index: 1001;
            color: white; opacity: 0; transition: opacity 0.5s, top 0.5s;
        }
        .notification.show { opacity: 1; top: 30px; }
        .optional-field-controls { display: flex; gap: 10px; margin-top: 20px; }
        .optional-field-controls select {
            flex-grow: 1;
            background-color: #222; /* Darker background */
            border-radius: 8px; /* Rounded corners */
            color: var(--text-color); /* White text */
            padding: 10px;
            border: 1px solid #555;
        }
        .dynamic-field { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
        .dynamic-field .form-group { flex-grow: 1; margin-bottom: 0; }

        /* --- Full Width Toggle Styles --- */
        .view-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.6em;
            font-weight: normal;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #555;
            transition: .4s;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
        }
        input:checked + .slider { background-color: var(--primary-color); }
        input:focus + .slider { box-shadow: 0 0 1px var(--primary-color); }
        input:checked + .slider:before { transform: translateX(22px); }
        .slider.round { border-radius: 28px; }
        .slider.round:before { border-radius: 50%; }
    </style>
</head>
<body>
    <div class="container">
        <h1>
            <span><i class="fa-solid fa-network-wired"></i> Roku Bridge Status & Config</span>
            <div class="view-toggle">
                <label for="fullscreen-toggle">Full Width</label>
                <label class="switch">
                    <input type="checkbox" id="fullscreen-toggle">
                    <span class="slider round"></span>
                </label>
            </div>
        </h1>

        <button class="button" onclick="fetchStatus()"><i class="fa-solid fa-sync"></i> Refresh Status</button>
        <div class="table-wrapper">
            <table id="status-table">
                <thead>
                    <tr>
                        <th>Tuner Name</th>
                        <th>Roku IP</th>
                        <th>Encoder URL</th>
                        <th style="text-align: center;">Status</th>
                    </tr>
                </thead>
                <tbody id="status-table-body"></tbody>
            </table>
        </div>

        <div class="section-header" style="padding-bottom: 10px; margin-top: 20px;">
             <h2><i class="fa-solid fa-globe"></i> Global Settings</h2>
        </div>
        <div class="global-settings">
            <p>These settings are configured at startup (e.g., in your Docker command) and cannot be changed here.</p>
            <p><strong>Default Encoding Mode:</strong> <code>{{ global_settings.encoding_mode }}</code></p>
            <p><strong>Audio Bitrate:</strong> <code>{{ global_settings.audio_bitrate }}</code></p>
            <p><strong>Audio Channels:</strong> <code>{{ global_settings.audio_channels }}</code></p>
            <p><strong>Debug Logging:</strong> <code>{{ 'Enabled' if global_settings.debug_logging else 'Disabled' }}</code></p>
        </div>

        <div class="section-header" style="padding-bottom: 10px; margin-top: 20px;">
            <h2><i class="fa-solid fa-satellite-dish"></i> Tuners</h2>
        </div>
        <div class="table-wrapper">
            <table id="tuners-table">
                <thead><tr><th>Name</th><th>Roku IP</th><th>Encoder URL</th><th>Priority</th><th>Encoding Mode</th><th>Actions</th></tr></thead>
                <tbody id="tuners-table-body"></tbody>
            </table>
        </div>
        <button class="button" onclick="openTunerModal()"><i class="fa-solid fa-plus"></i> Add Tuner</button>

        <div class="section-header" style="padding-bottom: 10px; margin-top: 20px;">
            <h2><i class="fa-solid fa-tv"></i> Gracenote Channels</h2>
            <span class="m3u-url">
                M3U: <a id="gracenote-m3u-url" href="/channels.m3u" target="_blank">/channels.m3u</a>
                <button class="action-button copy-button" title="Copy full URL" onclick="copyToClipboard('gracenote-m3u-url')"><i class="fa-solid fa-copy"></i></button>
            </span>
        </div>
        <div class="table-wrapper">
            <table id="channels-table">
                <thead><tr><th>Name</th><th>ID</th><th>App ID</th><th>Station ID</th><th>Actions</th></tr></thead>
                <tbody id="channels-table-body"></tbody>
            </table>
        </div>
        <button class="button" onclick="openChannelModal('gracenote')"><i class="fa-solid fa-plus"></i> Add Gracenote Channel</button>

        <div class="section-header" style="padding-bottom: 10px; margin-top: 20px;">
            <h2><i class="fa-solid fa-list-alt"></i> Custom EPG Channels</h2>
             <span class="m3u-url">
                M3U: <a id="epg-m3u-url" href="/epg_channels.m3u" target="_blank">/epg_channels.m3u</a>
                <button class="action-button copy-button" title="Copy full URL" onclick="copyToClipboard('epg-m3u-url')"><i class="fa-solid fa-copy"></i></button>
            </span>
        </div>
        <div class="table-wrapper">
            <table id="epg-channels-table">
                 <thead><tr><th>Name</th><th>ID</th><th>App ID</th><th>Channel #</th><th>Actions</th></tr></thead>
                <tbody id="epg-channels-table-body"></tbody>
            </table>
        </div>
        <button class="button" onclick="openChannelModal('epg')"><i class="fa-solid fa-plus"></i> Add EPG Channel</button>

        <button id="save-all-button" class="button" onclick="saveAllChanges()"><i class="fa-solid fa-save"></i> Save All Changes</button>

        <div class="section-header" style="padding-bottom: 10px; margin-top: 20px;">
            <h2><i class="fa-solid fa-file-import"></i> Backup & Restore</h2>
        </div>
        <div class="backup-restore">
            <button class="button" onclick="downloadConfig()"><i class="fa-solid fa-download"></i> Download Configuration</button>
            <hr style="border-color: var(--border-color); margin: 20px 0;">
            <form id="upload-form" action="/upload_config" method="post" enctype="multipart/form-data">
                <input type="file" name="file" id="file-input" required>
                <button type="submit" class="button"><i class="fa-solid fa-upload"></i> Upload</button>
            </form>
        </div>

        <div class="nav-links">
            <a href="/remote">Go to Remote</a>
        </div>
    </div>

    <div id="tuner-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="tuner-modal-title">Edit Tuner</h3>
                <span class="close-button" onclick="closeModal('tuner-modal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="tuner-form">
                    <input type="hidden" id="tuner-index">
                    <div class="form-group"><label for="tuner-name">Name</label><input type="text" id="tuner-name" required></div>
                    <div class="form-group"><label for="tuner-roku-ip">Roku IP</label><input type="text" id="tuner-roku-ip" required></div>
                    <div class="form-group"><label for="tuner-encoder-url">Encoder URL</label><input type="text" id="tuner-encoder-url" required></div>
                    <div class="form-group"><label for="tuner-priority">Priority</label><input type="number" id="tuner-priority" value="99"></div>
                    <div class="form-group">
                        <label for="tuner-encoding-mode">Encoding Mode (Optional)</label>
                        <select id="tuner-encoding-mode">
                            <option value="">Use Global Default</option>
                            <option value="proxy">Proxy</option>
                            <option value="remux">Remux</option>
                            <option value="reencode">Re-encode Audio</option>
                        </select>
                    </div>
                    <button type="submit" class="button">Save Tuner</button>
                </form>
            </div>
        </div>
    </div>

    <div id="gracenote-channel-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="gracenote-channel-modal-title">Edit Gracenote Channel</h3>
                <span class="close-button" onclick="closeModal('gracenote-channel-modal')">&times;</span>
            </div>
             <div class="modal-body">
                <form id="gracenote-channel-form">
                    <input type="hidden" id="gracenote-channel-index">
                    <div class="form-group"><label for="gracenote-name">Name</label><input type="text" id="gracenote-name" required></div>
                    <div class="form-group"><label for="gracenote-id">ID</label><input type="text" id="gracenote-id" required></div>
                    <div class="form-group"><label for="gracenote-roku-app-id">Roku App ID</label><input type="text" id="gracenote-roku-app-id" required></div>
                    <div class="form-group"><label for="gracenote-deep-link-content-id">Deep Link Content ID</label><input type="text" id="gracenote-deep-link-content-id"></div>
                    <div class="form-group">
                        <label for="gracenote-key-sequence">Key Sequence (Optional, comma-separated)</label>
                        <textarea id="gracenote-key-sequence" rows="3" placeholder="Example: Down,wait=2,Select,Right"></textarea>
                    </div>
                    <div class="form-group"><label for="gracenote-station-id">Gracenote Station ID</label><input type="text" id="gracenote-station-id" required></div>
                    <div class="form-group">
                        <label for="gracenote-media-type">Media Type</label>
                        <select id="gracenote-media-type">
                            <option value="live">live</option>
                            <option value="movie">movie</option>
                            <option value="episode">episode</option>
                            <option value="series">series</option>
                        </select>
                    </div>
                    <div class="form-group"><label for="gracenote-tune-delay">Tune Delay (seconds, optional)</label><input type="number" id="gracenote-tune-delay" placeholder="Default: 3"></div>
                    <div class="form-group-checkbox">
                        <input type="checkbox" id="gracenote-needs-select">
                        <label for="gracenote-needs-select">Needs "Select" Keypress After Tune</label>
                    </div>
                    <button type="submit" class="button">Save Channel</button>
                </form>
            </div>
        </div>
    </div>

    <div id="epg-channel-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="epg-channel-modal-title">Edit EPG Channel</h3>
                <span class="close-button" onclick="closeModal('epg-channel-modal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="epg-channel-form">
                    <input type="hidden" id="epg-channel-index">
                    <h4>Required Fields</h4>
                    <div class="form-group"><label for="epg-name">Name</label><input type="text" id="epg-name" required></div>
                    <div class="form-group"><label for="epg-id">ID</label><input type="text" id="epg-id" required></div>
                    <div class="form-group"><label for="epg-roku-app-id">Roku App ID</label><input type="text" id="epg-roku-app-id" required></div>
                    <div class="form-group"><label for="epg-deep-link-content-id">Deep Link Content ID (Optional)</label><input type="text" id="epg-deep-link-content-id"></div>
                     <div class="form-group">
                        <label for="epg-key-sequence">Key Sequence (Optional, comma-separated)</label>
                        <textarea id="epg-key-sequence" rows="3" placeholder="Example: Down,wait=2,Select,Right"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="epg-media-type">Media Type</label>
                        <select id="epg-media-type">
                            <option value="live">live</option>
                            <option value="movie">movie</option>
                            <option value="episode">episode</option>
                            <option value="series">series</option>
                        </select>
                    </div>
                    <div class="form-group-checkbox">
                        <input type="checkbox" id="epg-needs-select">
                        <label for="epg-needs-select">Needs "Select" Keypress After Tune</label>
                    </div>
                    <hr style="border-color: var(--border-color); margin: 20px 0;">
                    <h4>Optional Fields</h4>
                    <div id="dynamic-fields-container"></div>
                    <div class="optional-field-controls">
                        <select id="optional-field-select"></select>
                        <button type="button" class="button" onclick="addOptionalEpgField()">Add Field</button>
                    </div>
                    <button type="submit" class="button" style="margin-top: 20px;">Save Channel</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        let appConfig = { tuners: [], channels: [], epg_channels: [] };
        const epgOptionalFields = [
            'channel-number', 'tvg-logo', 'tvc-guide-art', 'tvc-guide-title',
            'tvc-guide-description', 'tvc-guide-tags', 'tvc-guide-genres',
            'tvc-guide-categories', 'tvc-guide-placeholders', 'tvc-stream-vcodec',
            'tvc-stream-acodec', 'tune_delay'
        ];

        // --- Core Functions ---
        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                appConfig = await response.json();
                renderAllTables();
            } catch (error) {
                console.error('Failed to load config:', error);
                showNotification('Error loading configuration.', 'error');
            }
        }

        async function saveAllChanges() {
            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(appConfig)
                });
                const result = await response.json();
                if (response.ok) {
                    showNotification(result.message || 'Configuration saved!', 'success');
                     setTimeout(() => window.location.reload(), 2000);
                } else {
                    throw new Error(result.error || 'Unknown error');
                }
            } catch (error) {
                console.error('Failed to save config:', error);
                showNotification(`Save failed: ${error.message}`, 'error');
            }
        }

        function downloadConfig() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appConfig, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "roku_channels.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            showNotification('Configuration downloaded.', 'success');
        }

        function copyToClipboard(elementId) {
            const urlElement = document.getElementById(elementId);
            const fullUrl = urlElement.href;
            navigator.clipboard.writeText(fullUrl).then(() => {
                showNotification('URL copied to clipboard!', 'success');
            }).catch(err => {
                showNotification('Failed to copy URL.', 'error');
            });
        }

        // --- Rendering Functions ---
        function renderAllTables() {
            renderTuners();
            renderChannels('gracenote');
            renderChannels('epg');
        }

        function renderTuners() {
            const tbody = document.getElementById('tuners-table-body');
            tbody.innerHTML = (appConfig.tuners || []).map((tuner, index) => `
                <tr>
                    <td>${tuner.name}</td>
                    <td>${tuner.roku_ip}</td>
                    <td>${tuner.encoder_url}</td>
                    <td>${tuner.priority || ''}</td>
                    <td>${tuner.encoding_mode || 'Default'}</td>
                    <td>
                        <button class="action-button edit" onclick="openTunerModal(${index})"><i class="fa-solid fa-pencil"></i></button>
                        <button class="action-button delete" onclick="deleteItem('tuners', ${index})"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function renderChannels(type) {
            const key = type === 'gracenote' ? 'channels' : 'epg_channels';
            const tbodyId = type === 'gracenote' ? 'channels-table-body' : 'epg-channels-table-body';
            const tbody = document.getElementById(tbodyId);

            tbody.innerHTML = (appConfig[key] || []).map((channel, index) => `
                <tr>
                    <td>${channel.name}</td>
                    <td>${channel.id}</td>
                    <td>${channel.roku_app_id}</td>
                    <td>${type === 'gracenote' ? channel.tvc_guide_stationid : (channel['channel-number'] || '')}</td>
                    <td>
                        <button class="action-button edit" onclick="openChannelModal('${type}', ${index})"><i class="fa-solid fa-pencil"></i></button>
                        <button class="action-button delete" onclick="deleteItem('${key}', ${index})"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        // --- Modal & Form Handling ---
        function openModal(id) { document.getElementById(id).style.display = 'block'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        function openTunerModal(index = null) {
            const form = document.getElementById('tuner-form');
            form.reset();
            document.getElementById('tuner-modal-title').textContent = index === null ? 'Add Tuner' : 'Edit Tuner';
            document.getElementById('tuner-index').value = index !== null ? index : '';

            if (index !== null) {
                const tuner = appConfig.tuners[index];
                document.getElementById('tuner-name').value = tuner.name || '';
                document.getElementById('tuner-roku-ip').value = tuner.roku_ip || '';
                document.getElementById('tuner-encoder-url').value = tuner.encoder_url || '';
                document.getElementById('tuner-priority').value = tuner.priority || 99;
                document.getElementById('tuner-encoding-mode').value = tuner.encoding_mode || '';
            }
            openModal('tuner-modal');
        }

        document.getElementById('tuner-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const index = document.getElementById('tuner-index').value;
            const tunerData = {
                name: document.getElementById('tuner-name').value,
                roku_ip: document.getElementById('tuner-roku-ip').value,
                encoder_url: document.getElementById('tuner-encoder-url').value,
                priority: parseInt(document.getElementById('tuner-priority').value, 10),
                encoding_mode: document.getElementById('tuner-encoding-mode').value
            };
            if (!tunerData.encoding_mode) delete tunerData.encoding_mode;

            if (index) {
                appConfig.tuners[parseInt(index, 10)] = tunerData;
            } else {
                appConfig.tuners.push(tunerData);
            }
            renderTuners();
            closeModal('tuner-modal');
        });

        function openChannelModal(type, index = null) {
            if (type === 'gracenote') {
                const form = document.getElementById('gracenote-channel-form');
                form.reset();
                document.getElementById('gracenote-channel-modal-title').textContent = index === null ? 'Add Gracenote Channel' : 'Edit Gracenote Channel';
                document.getElementById('gracenote-channel-index').value = index !== null ? index : '';

                if (index !== null) {
                    const channel = appConfig.channels[index];
                    document.getElementById('gracenote-name').value = channel.name || '';
                    document.getElementById('gracenote-id').value = channel.id || '';
                    document.getElementById('gracenote-roku-app-id').value = channel.roku_app_id || '';
                    document.getElementById('gracenote-deep-link-content-id').value = channel.deep_link_content_id || '';
                    document.getElementById('gracenote-key-sequence').value = (channel.key_sequence || []).join(',');
                    document.getElementById('gracenote-station-id').value = channel.tvc_guide_stationid || '';
                    document.getElementById('gracenote-media-type').value = channel.media_type || 'live';
                    document.getElementById('gracenote-tune-delay').value = channel.tune_delay || '';
                    document.getElementById('gracenote-needs-select').checked = channel.needs_select_keypress || false;
                }
                openModal('gracenote-channel-modal');
            } else if (type === 'epg') {
                const form = document.getElementById('epg-channel-form');
                form.reset();
                document.getElementById('dynamic-fields-container').innerHTML = '';
                document.getElementById('epg-channel-modal-title').textContent = index === null ? 'Add EPG Channel' : 'Edit EPG Channel';
                document.getElementById('epg-channel-index').value = index !== null ? index : '';

                populateOptionalFieldsDropdown();

                if (index !== null) {
                    const channel = appConfig.epg_channels[index];
                    document.getElementById('epg-name').value = channel.name || '';
                    document.getElementById('epg-id').value = channel.id || '';
                    document.getElementById('epg-roku-app-id').value = channel.roku_app_id || '';
                    document.getElementById('epg-deep-link-content-id').value = channel.deep_link_content_id || '';
                    document.getElementById('epg-key-sequence').value = (channel.key_sequence || []).join(',');
                    document.getElementById('epg-media-type').value = channel.media_type || 'live';
                    document.getElementById('epg-needs-select').checked = channel.needs_select_keypress || false;

                    for (const key of epgOptionalFields) {
                        if (key in channel) {
                            addOptionalEpgField(key, channel[key]);
                        }
                    }
                }
                openModal('epg-channel-modal');
            }
        }

        document.getElementById('gracenote-channel-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const index = document.getElementById('gracenote-channel-index').value;
            const channelData = {
                name: document.getElementById('gracenote-name').value,
                id: document.getElementById('gracenote-id').value,
                roku_app_id: document.getElementById('gracenote-roku-app-id').value,
                deep_link_content_id: document.getElementById('gracenote-deep-link-content-id').value,
                tvc_guide_stationid: document.getElementById('gracenote-station-id').value,
                media_type: document.getElementById('gracenote-media-type').value,
                needs_select_keypress: document.getElementById('gracenote-needs-select').checked
            };
            const tuneDelay = document.getElementById('gracenote-tune-delay').value;
            if (tuneDelay) channelData.tune_delay = parseInt(tuneDelay, 10);

            const keySequence = document.getElementById('gracenote-key-sequence').value;
            if (keySequence) channelData.key_sequence = keySequence.split(',').map(k => k.trim());


            if (!channelData.needs_select_keypress) delete channelData.needs_select_keypress;
            if (!channelData.deep_link_content_id) delete channelData.deep_link_content_id;
            if (!channelData.key_sequence || channelData.key_sequence.length === 0) delete channelData.key_sequence;


            if (index) {
                appConfig.channels[parseInt(index, 10)] = channelData;
            } else {
                if (!appConfig.channels) appConfig.channels = [];
                appConfig.channels.push(channelData);
            }
            renderChannels('gracenote');
            closeModal('gracenote-channel-modal');
        });

        document.getElementById('epg-channel-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const index = document.getElementById('epg-channel-index').value;
            const channelData = {
                name: document.getElementById('epg-name').value,
                id: document.getElementById('epg-id').value,
                roku_app_id: document.getElementById('epg-roku-app-id').value,
                deep_link_content_id: document.getElementById('epg-deep-link-content-id').value,
                media_type: document.getElementById('epg-media-type').value,
                needs_select_keypress: document.getElementById('epg-needs-select').checked
            };

            const keySequence = document.getElementById('epg-key-sequence').value;
            if (keySequence) channelData.key_sequence = keySequence.split(',').map(k => k.trim());

            document.querySelectorAll('#dynamic-fields-container .dynamic-field').forEach(fieldDiv => {
                const input = fieldDiv.querySelector('input');
                const key = input.dataset.key;
                const value = input.type === 'number' ? parseInt(input.value, 10) : input.value;
                if (value || value === 0) {
                    channelData[key] = value;
                }
            });

            if (!channelData.needs_select_keypress) delete channelData.needs_select_keypress;
            if (!channelData.deep_link_content_id) delete channelData.deep_link_content_id;
            if (!channelData.key_sequence || channelData.key_sequence.length === 0) delete channelData.key_sequence;


            if (index) {
                appConfig.epg_channels[parseInt(index, 10)] = channelData;
            } else {
                if (!appConfig.epg_channels) appConfig.epg_channels = [];
                appConfig.epg_channels.push(channelData);
            }
            renderChannels('epg');
            closeModal('epg-channel-modal');
        });

        function populateOptionalFieldsDropdown() {
            const select = document.getElementById('optional-field-select');
            select.innerHTML = '<option value="">-- Select a field to add --</option>';
            const existingFields = new Set([...document.querySelectorAll('#dynamic-fields-container input')].map(i => i.dataset.key));
            epgOptionalFields.forEach(field => {
                if (!existingFields.has(field)) {
                    const option = document.createElement('option');
                    option.value = field;
                    option.textContent = field;
                    select.appendChild(option);
                }
            });
        }

        function addOptionalEpgField(fieldName = null, value = '') {
            const select = document.getElementById('optional-field-select');
            const fieldToAdd = fieldName || select.value;
            if (!fieldToAdd) return;

            const container = document.getElementById('dynamic-fields-container');
            const newFieldDiv = document.createElement('div');
            newFieldDiv.className = 'dynamic-field';

            const isNumber = fieldToAdd === 'tune_delay';

            newFieldDiv.innerHTML = `
                <div class="form-group">
                    <label>${fieldToAdd}</label>
                    <input type="${isNumber ? 'number' : 'text'}" data-key="${fieldToAdd}" value="${value}">
                </div>
                <button type="button" class="action-button delete" onclick="removeOptionalField(this, '${fieldToAdd}')"><i class="fa-solid fa-trash"></i></button>
            `;
            container.appendChild(newFieldDiv);
            populateOptionalFieldsDropdown();
        }

        function removeOptionalField(button, fieldName) {
            button.parentElement.remove();
            populateOptionalFieldsDropdown();
        }

        document.getElementById('upload-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            const formData = new FormData(this);

            try {
                const response = await fetch('/upload_config', {
                    method: 'POST',
                    body: formData
                });
                const message = await response.text();
                showNotification(message, response.ok ? 'success' : 'error');
                if (response.ok) {
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                }
            } catch (error) {
                showNotification('Upload failed: ' + error.message, 'error');
            }
        });

        function deleteItem(key, index) {
            if (confirm('Are you sure you want to delete this item?')) {
                appConfig[key].splice(index, 1);
                renderAllTables();
            }
        }

        // --- Status Fetching ---
        async function fetchStatus() {
            const statusTableBody = document.getElementById('status-table-body');
            try {
                const response = await fetch('/api/status');
                const data = await response.json();

                if (statusTableBody.innerHTML === '' || statusTableBody.querySelectorAll('tr').length !== data.tuners.length) {
                     statusTableBody.innerHTML = (data.tuners || []).map(tuner => `
                        <tr>
                            <td>${tuner.name}</td>
                            <td>${tuner.roku_ip}</td>
                            <td>${tuner.encoder_url}</td>
                            <td class="status-icon" id="status-${tuner.roku_ip.replace(/\./g, '-')}">
                                <i class="fas fa-spinner fa-spin"></i>
                            </td>
                        </tr>
                    `).join('');
                }

                (data.statuses || []).forEach(status => {
                    const statusCell = document.getElementById(`status-${status.roku_ip.replace(/\./g, '-')}`);
                    if (statusCell) {
                        let iconHtml = '';
                        if (status.roku_status === 'online' && status.encoder_status === 'online') {
                            iconHtml = '<i class="fas fa-check-circle" title="Roku & Encoder Online"></i>';
                        } else {
                            iconHtml += status.roku_status === 'online' ? '<i class="fas fa-check-circle" title="Roku Online"></i> ' : '<i class="fas fa-times-circle" title="Roku Offline"></i> ';
                            iconHtml += status.encoder_status === 'online' ? '<i class="fas fa-check-circle" title="Encoder Online"></i>' : '<i class="fas fa-times-circle" title="Encoder Offline"></i>';
                        }
                        statusCell.innerHTML = iconHtml.trim();
                    }
                });
            } catch (error) {
                console.error('Error fetching status:', error);
                statusTableBody.innerHTML = '<tr><td colspan="4" style="text-align:center; color: var(--error-color);">Failed to load status.</td></tr>';
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification`;
            notification.style.backgroundColor = type === 'error' ? 'var(--error-color)' : 'var(--success-color)';
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.classList.add('show'), 10);
            setTimeout(() => {
                notification.classList.remove('show');
                notification.addEventListener('transitionend', () => notification.remove());
            }, 4000);
        }

        // --- Full Screen Toggle ---
        function applyFullScreenSetting() {
            const isFullScreen = localStorage.getItem('rokuBridgeFullScreen') === 'true';
            const container = document.querySelector('.container');
            const toggle = document.getElementById('fullscreen-toggle');

            if (isFullScreen) {
                container.classList.add('full-width');
                toggle.checked = true;
            } else {
                container.classList.remove('full-width');
                toggle.checked = false;
            }
        }

        function setupFullScreenToggle() {
            const toggle = document.getElementById('fullscreen-toggle');
            toggle.addEventListener('change', function() {
                if (this.checked) {
                    localStorage.setItem('rokuBridgeFullScreen', 'true');
                } else {
                    localStorage.setItem('rokuBridgeFullScreen', 'false');
                }
                applyFullScreenSetting();
            });
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchStatus();
            loadConfig();
            setupFullScreenToggle();
            applyFullScreenSetting();
            setInterval(fetchStatus, 30000);

            const host = window.location.origin;
            document.getElementById('gracenote-m3u-url').href = `${host}/channels.m3u`;
            document.getElementById('epg-m3u-url').href = `${host}/epg_channels.m3u`;
        });
    </script>
</body>
</html>
