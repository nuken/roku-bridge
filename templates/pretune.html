<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Roku Pre-Tuning</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <script src="https://cdn.jsdelivr.net/npm/mpegts.js@1.7.3/dist/mpegts.min.js"></script>
    <style>
        :root {
            --bg-color: #2c2c2c; --surface-color: #3a3a3a; --primary-color: #7dd3fc;
            --text-color: #e0e0e0; --border-color: #4a4a4a; --button-color: #555;
            --success-color: #28a745; --error-color: #dc3545; --warn-color: #ffc107;
            --available-color: #28a745; --in-use-color: #ffc107; --pre-tuning-color: #007bff;
            --recording-color: #9d31cc;
        }
        html, body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color); color: var(--text-color);
            margin: 0; padding: 0; height: 100%; overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }
        .pretune-container { display: flex; flex-direction: column; width: 100%; height: 100%; }
        .video-wrapper { position: relative; width: 100%; flex-grow: 1; background-color: #000; }
        video { width: 100%; height: 100%; object-fit: contain; }
        .controls-wrapper { background-color: var(--surface-color); padding: 15px; box-sizing: border-box; }
        .app-launcher select { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #555; background-color: var(--border-color); color: var(--text-color); font-size: 1em; margin-bottom: 15px; -webkit-appearance: none; appearance: none; }
        #start-stream, #stop-session { width: 100%; padding: 15px; border-radius: 12px; border: none; font-size: 1.2em; color: white; cursor: pointer; margin-top: 10px; }
        #start-stream { background-color: var(--success-color); }
        #stop-session { background-color: var(--error-color); }
        .recording-options { background-color: var(--border-color); padding: 15px; border-radius: 12px; margin-top: 15px; display: none; }
        .form-group-checkbox { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        .form-group-checkbox input[type="checkbox"] { width: 20px; height: 20px; }
        .form-group { margin-bottom: 10px; }
        .form-group label { display: block; margin-bottom: 5px; }
        .form-group input, .form-group textarea { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #555; background-color: var(--bg-color); color: var(--text-color); font-size: 1em; box-sizing: border-box; }
        .fetch-buttons { display: flex; gap: 10px; margin-bottom: 15px; }
        .fetch-button { flex-grow: 1; padding: 10px; border-radius: 8px; border: none; font-size: 0.9em; color: white; cursor: pointer; }
        #fetch-roku-btn { background-color: #6f42c1; }
        #search-tmdb-btn { background-color: #0d6efd; }
        .full-remote, .remote-overlay { /* styles omitted for brevity */ }
        .notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); padding: 10px 20px; border-radius: 8px; z-index: 1001; color: white; opacity: 0; transition: opacity 0.5s, top 0.5s; }
        .notification.show { opacity: 1; top: 30px; }
        .tuner-list, .tuner-item, .status { /* styles omitted */ }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); align-items: center; justify-content: center; }
        .modal-content { background-color: var(--surface-color); padding: 25px; border-radius: 12px; width: 90%; max-width: 500px; text-align: center; display: flex; flex-direction: column; max-height: 80vh; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 10px; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); }
        .modal-header h3 { margin: 0; color: var(--primary-color); }
        .modal-body { overflow-y: auto; text-align: left; }
        .search-result { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid var(--border-color); cursor: pointer; }
        .search-result:hover { background-color: #444; }
        .search-result img { width: 40px; height: 60px; object-fit: cover; border-radius: 4px; margin-right: 15px; background-color: #222; }
        .search-result-info { display: flex; flex-direction: column; }
        .search-result-info span { font-size: 0.9em; color: #ccc; }
        .modal-footer { /* styles omitted */ }
    </style>
</head>
<body>
    <div class="pretune-container">
        <div class="controls-wrapper">
             <h1><i class="fa-solid fa-satellite-dish"></i> Pre-Tune Control</h1>
             <div id="tuner-list-container">
                <h3>Select a Tuner</h3>
                <div id="tuner-list"></div>
             </div>
             <hr style="border-color: var(--border-color); margin: 20px 0;">
             <div class="app-launcher">
                <select id="app-launcher" onchange="launchApp()"></select>
             </div>
             <div class="full-remote" style="display:none;"></div>
             <div class="recording-options" id="recording-options">
                 <div class="form-group-checkbox">
                    <input type="checkbox" id="record-checkbox">
                    <label for="record-checkbox">Record on Channels DVR</label>
                </div>
                <div id="metadata-group" style="display: none;">
                    <div class="fetch-buttons">
                        <button class="fetch-button" id="fetch-roku-btn" onclick="fetchRokuInfo()"><i class="fa-brands fa-adn"></i> Fetch from Roku</button>
                        <button class="fetch-button" id="search-tmdb-btn" onclick="searchTmdb()"><i class="fa-solid fa-film"></i> Search Online</button>
                    </div>
                    <div class="form-group">
                        <label for="title-input">Title</label>
                        <input type="text" id="title-input" placeholder="Enter title to search online">
                    </div>
                    <div class="form-group">
                        <label for="duration-input">Duration (minutes)</label>
                        <input type="number" id="duration-input" value="120" min="1">
                    </div>
                     <div class="form-group">
                        <label for="subtitle-input">Subtitle / Episode (Optional)</label>
                        <input type="text" id="subtitle-input">
                    </div>
                    <div class="form-group">
                        <label for="description-input">Description (Optional)</label>
                        <textarea id="description-input" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="image-input">Image URL (Optional)</label>
                        <input type="text" id="image-input" placeholder="Auto-filled by search">
                    </div>
                </div>
             </div>
             <button id="start-stream" onclick="startStream()">Send to Channels</button>
             <button id="stop-session" onclick="stopSession()">Stop Session & Release Tuner</button>
        </div>
        <div class="video-wrapper">
            <video id="video-player" autoplay muted playsinline></video>
        </div>
    </div>

    <div id="takeover-modal" class="modal"></div>
    <div id="tmdb-results-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Search Results</h3>
                <span class="close-button" onclick="closeModal('tmdb-results-modal')">&times;</span>
            </div>
            <div class="modal-body" id="tmdb-results-body"></div>
        </div>
    </div>

    <script>
        // --- Global variables ---
        let player, activeTunerIp = null;

        // --- Core Functions (showNotification, cleanupPlayer, etc.) ---
        function showNotification(message, type = 'success') { /* implementation unchanged */ }
        function cleanupPlayer() { /* implementation unchanged */ }
        
        // --- Session and Tuner Management ---
        async function fetchTunerStatus() { /* implementation unchanged */ }
        function renderTunerList(tuners) { /* implementation unchanged */ }
        function handleSessionStart(tunerIp, isTakeover) { /* implementation unchanged */ }
        async function startSession(tunerIp, isTakeover) { /* implementation mostly unchanged, ensure it shows recording options */ }
        async function stopSession(tunerToStop = null, silent = false) { /* implementation mostly unchanged, ensure it resets and hides recording UI */ }
        
        // --- Remote and App Control ---
        async function launchApp() { /* implementation unchanged */ }
        async function sendKey(key) { /* implementation unchanged */ }

        // --- NEW METADATA FUNCTIONS ---
        async function fetchRokuInfo() {
             if (!activeTunerIp) { showNotification('Please start a session first.', 'error'); return; }
             try {
                const response = await fetch('/api/pretune/fetch_info', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ tuner_ip: activeTunerIp })
                });
                const data = await response.json();
                if (data.status === 'success' && data.metadata) {
                    if(data.metadata.title) document.getElementById('title-input').value = data.metadata.title;
                    if(data.metadata.subtitle) document.getElementById('subtitle-input').value = data.metadata.subtitle;
                    if(data.metadata.duration) document.getElementById('duration-input').value = data.metadata.duration;
                    showNotification('Metadata fetched successfully!', 'success');
                } else if (data.status === 'nodata') {
                    showNotification('No metadata available from this app. Please enter manually.', 'warn');
                } else { throw new Error(data.message || 'Failed to fetch info.'); }
             } catch (error) { showNotification(`Error fetching info: ${error.message}`, 'error'); }
        }

        async function searchTmdb() {
            const query = document.getElementById('title-input').value;
            if (!query) { showNotification('Please enter a title to search.', 'warn'); return; }
            
            try {
                const response = await fetch('/api/metadata/search', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ query: query, type: 'multi' })
                });
                const data = await response.json();
                if (data.status === 'error') throw new Error(data.message);
                
                const resultsBody = document.getElementById('tmdb-results-body');
                resultsBody.innerHTML = ''; // Clear previous results
                if (data.results && data.results.length > 0) {
                    data.results.forEach(item => {
                        const resultDiv = document.createElement('div');
                        resultDiv.className = 'search-result';
                        resultDiv.onclick = () => getTmdbDetails(item.id, item.type);
                        resultDiv.innerHTML = `
                            <img src="${item.poster || ''}" alt="Poster">
                            <div class="search-result-info">
                                <strong>${item.title} (${item.year})</strong>
                                <span>Type: ${item.type}</span>
                            </div>
                        `;
                        resultsBody.appendChild(resultDiv);
                    });
                    openModal('tmdb-results-modal');
                } else {
                    showNotification('No results found online.', 'warn');
                }
            } catch (error) { showNotification(`Search failed: ${error.message}`, 'error'); }
        }

        async function getTmdbDetails(id, type) {
            try {
                const response = await fetch('/api/metadata/details', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ id: id, type: type })
                });
                const data = await response.json();
                if (data.status === 'error') throw new Error(data.message);
                
                if (data.metadata) {
                    if (data.metadata.description) document.getElementById('description-input').value = data.metadata.description;
                    if (data.metadata.image) document.getElementById('image-input').value = data.metadata.image;
                    showNotification('Details populated!', 'success');
                }
                closeModal('tmdb-results-modal');
            } catch (error) { showNotification(`Failed to get details: ${error.message}`, 'error'); }
        }

        // --- Stream Commitment ---
        async function startStream() {
            if (!activeTunerIp) { showNotification('Please start a session first.', 'error'); return; }
            
            const shouldRecord = document.getElementById('record-checkbox').checked;
            const duration = parseInt(document.getElementById('duration-input').value, 10);
            const metadata = {
                title: document.getElementById('title-input').value,
                subtitle: document.getElementById('subtitle-input').value,
                description: document.getElementById('description-input').value,
                image: document.getElementById('image-input').value
            };

            if (shouldRecord && (!duration || duration < 1)) { showNotification('A valid duration is required.', 'error'); return; }
            if (shouldRecord && !metadata.title) { showNotification('A title is required for recording.', 'error'); return; }

            try {
                const response = await fetch('/api/pretune/commit', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tuner_ip: activeTunerIp, record: shouldRecord, duration: duration, metadata: metadata })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.message || 'Failed to commit stream.');
                
                showNotification(data.message, 'success');
                // Reset UI after successful commit
                stopSession(null, true); // Stop session silently
                
            } catch (error) { showNotification(`Error: ${error.message}`, 'error'); }
        }

        // --- Event Listeners and Init ---
        document.getElementById('record-checkbox').addEventListener('change', function() {
            document.getElementById('metadata-group').style.display = this.checked ? 'block' : 'none';
        });

        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        // Full implementations of other functions (fetchTunerStatus, startSession, stopSession, etc.) would go here.
        // They are mostly unchanged from the previous version, just ensure they correctly show/hide/reset the new UI elements.
        
        document.addEventListener('DOMContentLoaded', () => {
            // Fill in full JS from previous versions here, then add init calls
            fetchTunerStatus();
            setInterval(fetchTunerStatus, 15000);
        });

    </script>
</body>
</html>