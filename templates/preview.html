<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roku Channel Preview</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <script src="https://cdn.jsdelivr.net/npm/mpegts.js@1.7.3/dist/mpegts.min.js"></script>
    <style>
        :root {
            --bg-color: #2c2c2c; --surface-color: #3a3a3a; --primary-color: #7dd3fc;
            --text-color: #e0e0e0; --border-color: #4a4a4a; --error-color: #dc3545;
            --button-color: #007bff; --button-hover-color: #0056b3;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 20px;
        }
        .header-actions { display: flex; justify-content: flex-end; align-items: center; gap: 10px; margin-bottom: 20px; }
        .nav-buttons a { background-color: var(--button-color); color: white; padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; text-decoration: none; transition: background-color 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .nav-buttons a:hover { background-color: var(--button-hover-color); color: white; }
        .container { display: flex; width: 100%; gap: 20px; height: calc(100vh - 100px); }
        .channel-list-container {
            background-color: var(--surface-color); border-radius: 20px; padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4); width: 30%; overflow-y: auto;
            display: flex; flex-direction: column;
        }
        .video-container { background-color: #000; border-radius: 20px; width: 70%; height: 100%; display: flex; align-items: center; justify-content: center; }
        video { width: 100%; height: 100%; border-radius: 20px; object-fit: contain; background-color: #000; }
        h1 { text-align: center; color: var(--primary-color); margin-top: 0; margin-bottom: 20px; font-size: 1.5em; }
        ul { list-style: none; padding: 0; margin: 0; flex-grow: 1; }
        li { padding: 15px; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background-color 0.2s; }
        li:hover, li.active { background-color: var(--border-color); }
        li:last-child { border-bottom: none; }
        #stop-preview {
            width: 100%; padding: 15px; border-radius: 12px; border: none; font-size: 1.2em;
            background-color: var(--error-color); color: white; cursor: pointer; margin-top: 20px; margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="header-actions">
        <div class="nav-buttons">
            <a href="/status">Status & Config</a>
            <a href="/remote">Remote</a>
            <a href="/pretune">On-Demand Pre-Tune</a>
        </div>
    </div>
    <div class="container">
        <div class="channel-list-container">
            <h1><i class="fa-solid fa-list"></i> Channels</h1>
            
            <button id="stop-preview" onclick="stopPreview()">Stop Preview & Release Tuner</button>
            <ul id="channel-list">
                {% for channel in channels %}
                    <li id="channel-{{ channel.id }}" onclick="playChannel('{{ channel.id }}', this)">{{ channel.name }}</li>
                {% endfor %}
            </ul>
        </div>
        <div class="video-container">
            <video id="video-player" controls autoplay muted playsinline></video>
        </div>
    </div>
    <script>
        const videoElement = document.getElementById('video-player');
        const channelList = document.getElementById('channel-list');
        let player;

        function cleanupPlayer() {
            if (player) {
                player.unload();
                player.detachMediaElement();
                player.destroy();
                player = null;
            }
            videoElement.src = "";
            const currentlyActive = channelList.querySelector('.active');
            if (currentlyActive) {
                currentlyActive.classList.remove('active');
            }
        }
        
        function stopPreview() {
            // First, tell the server to release the tuner and send the Roku home
            fetch('/api/preview/stop', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        console.log("Successfully released tuner.");
                    } else {
                        console.warn("Could not release tuner via API, but cleaning up player anyway.", data.message);
                    }
                })
                .catch(error => {
                    console.error("Error calling stop preview API:", error);
                })
                .finally(() => {
                    // This will stop the video and close the connection,
                    // which also triggers the server to release the tuner.
                    // This acts as a fallback if the API call fails.
                    cleanupPlayer();
                });
        }
        
        window.addEventListener('beforeunload', cleanupPlayer);

        function playChannel(channelId, element) {
            cleanupPlayer();

            element.classList.add('active');

            const streamUrl = `/stream/${channelId}?preview=true`;
            
            if (mpegts.isSupported()) {
                player = mpegts.createPlayer({
                    type: 'mpegts',
                    isLive: true,
                    url: streamUrl
                });
                player.attachMediaElement(videoElement);
                player.load();
                player.play();
            } else {
                alert('Your browser does not support mpegts.js playback.');
            }
        }
    </script>
</body>
</html>